window.onload = function () {

    var Game = function (options) {
        // get options
        var canvas  = options.canvas;
        var context = options.context;
        var player  = options.player;
        var highs   = options.highs;

        var exports = {};

        var over        = false;
        var stepLoop    = null;

        var welcome     = new Audio('sounds/wanna_get_high.wav');
        welcome.play();

        var goodbye     = new Audio('sounds/bring_a_towel.wav');

        var bg          = new Image();
        bg.src          = 'images/bg.jpg';

        var gameOverBg  = new Image();
        gameOverBg.src  = 'images/game_over.jpg';

        function gameOver () {
            clearTimeout(stepLoop);
            clear();
            context.drawImage(gameOverBg, 0, 0);
            goodbye.play();
        }

        function clear () {
            // clear canvas
            //context.clearRect(0, 0, canvas.width, canvas.height);

            /*
            //this paints with a color for bg
            context.fillStyle = '#555555';
            context.beginPath();
            context.rect(0, 0, canvas.width, canvas.height);
            context.closePath();
            context.fill();
            */
            context.drawImage(bg, 0, 0);
        }

        // GRAPHICS UPDATE
        function render () {
            if (!over) {
                clear();
            }

            player.draw();

            if (over) {
                gameOver();
            }
        }

        // THIS IS THE GAME LOGIC
        exports.step = function () {
            player.update();
            if (player.isWinner) {
                over = true;
            }
            stepLoop = setTimeout(exports.step, 20);
            render();
        }
        exports.keyboard = function (e) {
            if (highs[e.keyCode]) {
                player.getHigh(highs[e.keyCode]);
            }
            else if (e.keyCode == 37) {
                player.moveLeft();
            }
            else if (e.keyCode == 39) {
                player.moveRight();
            }
        }

        return exports;
    };

    // HIGH MODEL
    var High = function (options) {
        var exports = {};
        
        //name
        exports.name        = options.name;
        // time it takes to make effect
        exports.delay       = options.delay;
        // how high it gets
        exports.speed       = options.speed;
        // how long it stays high, before comedown
        exports.duration    = options.duration;
        // toleranca
        exports.tolerance   = options.tolerance;

        return exports;
    };

    // PLAYER MODEL
    var Player = function (options) {
        // get options
        var context = options.context;

        var exports = {};

        var image = new Image();
        image.src = 'images/player_sprite.png'

        // size of the player in the sprite
        var originalWidth  = 44;
        var originalHeight = 60;

        // desired size of player in the screen
        var sizeWidth      = 44;
        var sizeHeight     = 60;

        // initial position
        var y               = canvas.height - sizeHeight;
        var x               = (canvas.width * 0.5) - (sizeWidth * 0.5);

        var isHigh          = false;
        var speed           = 0;
        var toleranceShort  = [];
        var toleranceLong   = [];
        var highOn          = [];

        // player is not a winner
        // until proved otherwise
        exports.isWinner = false;

        exports.draw = function () {
            var position = 0;
            if (y < 100) {
                position = 4;
            }
            else if (y < 300) {
                position = 3;
            }
            else if (y < 550) {
                position = 2;
            }
            else if (y < canvas.height - sizeHeight) {
                position = 1;
            }
            context.drawImage(image, position * originalWidth, 0, originalWidth, originalHeight, x, y, sizeWidth, sizeHeight);
        }
        function comeDown (high) {
            highOn[high.name]--;
            toleranceShort[high.name] -= high.tolerance;
            // after all come downs
            isHigh         = stillHigh();
            // update effect
            canvas.style.polyfilter = effects();
        }
        function stillHigh () {
            for (i in highOn) {
                if (highOn[i] > 0) {
                    return true;
                }
            }
            return false;
        }
        function getTolerance (high) {
            if (!toleranceLong[high.name]) {
                toleranceLong[high.name] = 0;
            }
            if (!toleranceShort[high.name]) {
                toleranceShort[high.name] = 0;
            }
            tolerance                   = (parseInt(toleranceLong[high.name]) * 0.01) + (parseInt(toleranceShort[high.name]) * 0.1) + 1; 
            toleranceShort[high.name]  += high.tolerance;
            toleranceLong[high.name]   += high.tolerance;
            return tolerance;
        }
        function effects () {
            if (!isHigh) {
                return 'none';
            }
            var blur        = 0;
            var invert      = 0;
            var brightness  = 100;
            for (name in highOn) {
                if (!highOn[name]) {
                    continue;
                }
                switch (name) {
                    case 'tobacco':
                        blur += 0;
                    break;

                    case 'alcohol':
                        blur += 2;
                    break;

                    case 'marijuana':
                        blur += 1;
                    break;

                    case 'heroine':
                        blur += 2;
                    break;

                    case 'cocaine':
                    break;

                    case 'ecstasy':
                        brightness -= 10;
                    break;

                    case 'lsd':
                        invert = 1;
                    break;

                    case 'psilocybin':
                        blur += 1;
                        invert = 1;
                    break;
                }
            }
            return 'blur(' + blur + 'px) invert(' + invert + ') brightness(' + brightness + '%)';
        }
        exports.getHigh = function (high) {
            setTimeout(function () {
                isHigh     = true;
                if (!highOn[high.name]) {
                    highOn[high.name] = 0;
                }
                highOn[high.name]++;
                // update effect
                canvas.style.polyfilter = effects();
                tolerance   = getTolerance(high);
                duration    = high.duration / tolerance;
                speed       += high.speed / tolerance;
                // TODO apply overdose
                if (speed > 200) {
                    overdose = true;
                }
                setTimeout(function () { comeDown(high); }, duration);
            }, high.delay);
        }
        exports.update = function () {
            // reach the top, win the game
            if (y < 0) {
                exports.isWinner = true;
                return;
            }

            // falling till the floor
            if (y < canvas.height - sizeHeight) {
                y++;
            }

            // getting high
            if (isHigh) {
                y -= speed;

                if (speed > 1) {
                    speed--;
                }
            }
        }
        exports.moveLeft = function () {
            x -= 50;
            if (x < 0) {
                exports.moveRight();
            }
        }
        exports.moveRight = function () {
            x += 50;
            if (x > canvas.width - sizeWidth) {
                exports.moveLeft();
            }
        }
        return exports;
    };

    // GLOBALS
    var canvas      = document.getElementById('game-canvas');
    var context     = canvas.getContext('2d');
    canvas.width    = 360;
    canvas.height   = 640;

    // all highs
    var tobacco     = new High({
        name: 'tobacco',
        tolerance: 1,
        delay: 200,
        speed: 2,
        duration: 1000
        });
    var alcohol     = new High({
        name: 'alcohol',
        tolerance: 2,
        delay: 300,
        speed: 10,
        duration: 3000
        });
    var marijuana   = new High({
        name: 'marijuana',
        tolerance: 3,
        delay: 200,
        speed: 5,
        duration: 2000
        });
    var cocaine     = new High({
        name: 'cocaine',
        tolerance: 4,
        delay: 50,
        speed: 20,
        duration: 500
        });
    var heroine     = new High({
        name: 'heroine',
        tolerance: 10,
        delay: 0,
        speed: 35,
        duration: 500
        });
    var ecstasy     = new High({
        name: 'ecstasy',
        tolerance: 8,
        delay: 1000,
        speed: 15,
        duration: 3000
        });
    var lsd         = new High({
        name: 'lsd',
        tolerance: 9,
        delay: 1000,
        speed: 18,
        duration: 3000
        });
    var psilocybin  = new High({
        name: 'psilocybin',
        tolerance: 9,
        delay: 1000,
        speed: 10,
        duration: 3000
        });

    var player      = new Player({
        context: context
    });
    var game        = new Game({
        canvas: canvas,
        context: context,
        player: player,
        /*
        T = Tabacco => 84
        A = Alcohol => 65
        M = Marijuana => 77
        H = Heroin => 72
        C = Cocaine => 67
        E = Ecstasy => 69
        L = LSD => 76
        P = Psilocybin => 80
        */
        highs: {
            '84': tobacco,
            '65': alcohol,
            '77': marijuana,
            '72': heroine,
            '67': cocaine,
            '69': ecstasy,
            '76': lsd,
            '80': psilocybin
        }
    });
    //window.mozRequestAnimationFrame(game.render);
    window.addEventListener('keydown', game.keyboard, false);
    //setInterval(game.step, 1);
    game.step();
}

/*
Common Used Highs

Tobacco
    Nicotine
Alcohol
    Alcohol (ethyl alcohol)
Cannabinoids
    Marijuana
    Hashish
Opioids
    Heroin
    Opium
Stimulants
    Cocaine
    Amphetamine
    Methamphetamine
Club
    MDMA (ecstasy)
    Flunitrazepam
    GHB
Dissociative
    Ketamine
    PCP
    Salvia
    DXM
Hallucinogens
    LSD
    Mescaline
    Psilocybin (Mushroom)
*/
